<!-- csv-upload.component.html -->
<div class="upload-container">

  <!-- Upload Step -->
  @if (currentStep() === 'upload') {
    <div class="upload-card">
      <!-- Header -->
      <div class="upload-header">
        <h1>Upload Your Bank Statement</h1>
        <p class="subtitle">Import transactions from your bank statement file</p>
      </div>

      <!-- Account Picker -->
      <div class="account-section">
        <app-account-picker></app-account-picker>
      </div>

      <!-- Bank Selection -->
      @if (accountService.selectedAccountId()) {
        <div class="bank-section">
          <label class="bank-label">Select Your Bank</label>
          <div class="bank-selector">
            <select
              class="bank-select"
              [(ngModel)]="selectedBank">
              <option value="AUTO">üîç Auto-Detect</option>
              @for (bank of supportedBanks(); track bank.id) {
                <option [value]="bank.id">
                  {{ bank.name }} ({{ bank.supportedFormats.join(', ') }})
                </option>
              }
            </select>
          </div>
          <p class="bank-hint">
            @if (selectedBank() === 'AUTO') {
              We'll automatically detect your bank from the file
            } @else {
              Accepted formats: {{ getBankFormats(selectedBank()) }}
            }
          </p>
        </div>
      }

      <!-- Error Banner -->
      @if (error()) {
        <div class="error-banner">
          <svg class="error-icon" viewBox="0 0 24 24">
            <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-2h2v2zm0-4h-2V7h2v6z"/>
          </svg>
          <span>{{ error() }}</span>
          <button class="error-close" (click)="error.set(null)">&times;</button>
        </div>
      }

      <!-- Drop Zone -->
      <div class="drop-zone"
           [class.dragging]="isDragging()"
           [class.disabled]="!accountService.selectedAccountId()"
           (dragover)="onDragOver($event)"
           (dragleave)="onDragLeave($event)"
           (drop)="onDrop($event)">

        <svg class="upload-icon" viewBox="0 0 24 24">
          <path d="M9 16h6v-6h4l-7-7-7 7h4zm-4 2h14v2H5z"/>
        </svg>

        @if (accountService.selectedAccountId()) {
          <div>
            <h3>Drop your statement file here</h3>
            <p>or</p>

            <label class="btn file-input-label">
              Browse Files
              <input type="file"
                     [accept]="acceptedFileTypes()"
                     (change)="onFileSelect($event)"
                     class="file-input">
            </label>

            <p class="file-hint">
              @if (selectedBank() === 'AUTO') {
                Supported: CSV, TXT, Excel files from HDFC, SBI, and more
              } @else {
                Supported: {{ getBankFormats(selectedBank()) }} files from {{ getBankDisplayName(selectedBank()) }}
              }
            </p>
          </div>
        } @else {
          <div class="disabled-message">
            <h3>Select an account first</h3>
            <p>Please choose or create an account above to start importing transactions</p>
          </div>
        }
      </div>

      <!-- Progress Bar -->
      @if (isParsing() && parseProgress()) {
        <div class="progress-container">
          <div class="progress-stages">
            <div class="stage" [class.active]="parseProgress()!.stage === 'reading'">
              üìñ Reading
            </div>
            <div class="stage" [class.active]="parseProgress()!.stage === 'detecting'">
              üîç Detecting
            </div>
            <div class="stage" [class.active]="parseProgress()!.stage === 'parsing'">
              ‚öôÔ∏è Parsing
            </div>
            <div class="stage" [class.active]="parseProgress()!.stage === 'validating'">
              ‚úì Validating
            </div>
          </div>

          <div class="progress-message">
            {{ parseProgress()!.message }}
          </div>

          @if (parseProgress()!.stage === 'parsing') {
            <div class="progress-stats">
              <span>Found: {{ parseProgress()!.transactionsFound }} transactions</span>
              <span>Skipped: {{ parseProgress()!.skippedRows }} rows</span>
            </div>
          }

          @if (detectedBank()) {
            <div class="detected-bank">
              <svg viewBox="0 0 24 24" width="20" height="20">
                <path fill="currentColor" d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/>
              </svg>
              Detected: {{ getBankDisplayName(detectedBank()!) }}
            </div>
          }
        </div>
      }
    </div>
  }

  <!-- Review Step -->
  @if (currentStep() === 'review' && reviewData()) {
    <div class="review-card">
      <app-import-review
        [reviewData]="reviewData()!"
        (onConfirm)="onImportConfirmed()"
        (onCancel)="onImportCancelled()">
      </app-import-review>
    </div>
  }
</div>

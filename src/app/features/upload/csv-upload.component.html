<!-- csv-upload.component.html -->
<div class="upload-container">

  <!-- Upload Step -->
  @if (currentStep() === 'upload') {
    <div class="upload-card">
      <!-- Header -->
      <div class="upload-header">
        <h1>Upload Your Bank Statement</h1>
        <p class="subtitle">Import transactions from your bank statement file</p>
      </div>

      <!-- Account Picker -->
      <div class="account-section">
        <app-account-picker></app-account-picker>
      </div>

      <!-- Selected Account Info -->
      @if (accountService.selectedAccount(); as account) {
        <div class="selected-account-info">
          <div class="info-badge">
            <svg viewBox="0 0 24 24" width="20" height="20">
              <path fill="currentColor" d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>
            </svg>
            <span>Uploading to: <strong>{{ account.name }}</strong> ({{ account.bankName }})</span>
          </div>
          <p class="info-text">
            Please upload a {{ account.bankName }} bank statement in {{ expectedFormats() }} format
          </p>
        </div>
      }

      <!-- Error Banner -->
      @if (error()) {
        <div class="error-banner">
          <svg class="error-icon" viewBox="0 0 24 24">
            <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-2h2v2zm0-4h-2V7h2v6z"/>
          </svg>
          <span>{{ error() }}</span>
          <button class="error-close" (click)="error.set(null)">&times;</button>
        </div>
      }

      <!-- Drop Zone -->
      <div class="drop-zone"
           [class.dragging]="isDragging()"
           [class.disabled]="!accountService.selectedAccountId()"
           (dragover)="onDragOver($event)"
           (dragleave)="onDragLeave($event)"
           (drop)="onDrop($event)">

        <svg class="upload-icon" viewBox="0 0 24 24">
          <path d="M9 16h6v-6h4l-7-7-7 7h4zm-4 2h14v2H5z"/>
        </svg>

        @if (accountService.selectedAccountId()) {
          <div>
            <h3>Drop your {{ accountService.selectedAccount()?.bankName }} statement here</h3>
            <p>or</p>

            <label class="btn file-input-label">
              Browse Files
              <input type="file"
                     [accept]="acceptedFileTypes()"
                     (change)="onFileSelect($event)"
                     class="file-input">
            </label>

            <p class="file-hint">
              Accepted formats: {{ expectedFormats() }}
            </p>
          </div>
        } @else {
          <div class="disabled-message">
            <h3>Select an account first</h3>
            <p>Please choose or create an account above to start importing transactions</p>
          </div>
        }
      </div>

      <!-- Progress Bar -->
      @if (isParsing() && parseProgress()) {
        <div class="progress-container">
          <div class="progress-stages">
            <div class="stage" [class.active]="parseProgress()!.stage === 'reading'">
              üìñ Reading
            </div>
            <div class="stage" [class.active]="parseProgress()!.stage === 'detecting'">
              üîç Validating
            </div>
            <div class="stage" [class.active]="parseProgress()!.stage === 'parsing'">
              ‚öôÔ∏è Parsing
            </div>
            <div class="stage" [class.active]="parseProgress()!.stage === 'validating'">
              ‚úì Finalizing
            </div>
          </div>

          <div class="progress-message">
            {{ parseProgress()!.message }}
          </div>

          @if (parseProgress()!.stage === 'parsing') {
            <div class="progress-stats">
              <span>Found: {{ parseProgress()!.transactionsFound }} transactions</span>
              <span>Skipped: {{ parseProgress()!.skippedRows }} rows</span>
            </div>
          }

          <div class="processing-bank">
            <svg viewBox="0 0 24 24" width="20" height="20">
              <path fill="currentColor" d="M11.5 1L2 6v2h19V6M16 10v7h3v-7M2 22h19v-3H2m8-9v7h3v-7m-9 0v7h3v-7"/>
            </svg>
            Processing {{ accountService.selectedAccount()?.bankName }} statement
          </div>
        </div>
      }
    </div>
  }

  <!-- Review Step -->
  @if (currentStep() === 'review' && reviewData()) {
    <div class="review-card">
      <app-import-review
        [reviewData]="reviewData()!"
        (onConfirm)="onImportConfirmed()"
        (onCancel)="onImportCancelled()">
      </app-import-review>
    </div>
  }
</div>
